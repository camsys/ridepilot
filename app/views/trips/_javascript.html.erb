<%= render "shared/date_time_picker_javascript" %>
<script type='text/javascript'>
  function autocompleted(address, field) {
    if (address.id) {
      populate_address_form(field, address);
      update_address_fields(field, address);
      $( "#" + field + "-address-form" ).dialog( "close" );
      $("." + field + "_address_details").show();
    } else if (address.label == "New Address") {
      populate_address_form(field, {});
      open_form_for_creating(field);
    } else {
      //found a geocode, fill in fields, open the dialog for saving
      populate_address_form(field, address);
      open_form_for_creating(field);
    }
  }
  
  function populate_address_form(field, address) {
    form = $("#" + field + "-address-form");
    form.find('#address_id').val(address.id);
    form.find('#' + field + '_name').val(address.name);
    form.find('#' + field + '_building_name').val(address.building_name);
    form.find('#' + field + '_address').val(address.address);
    form.find('#' + field + '_city').val(address.city);
    form.find('#' + field + '_state').val(address.state);
    form.find('#' + field + '_zip').val(address.zip);
    form.find('#' + field + '_lat').val(address.lat);
    form.find('#' + field + '_lon').val(address.lon);
    form.find('#' + field + '_in_district').val(address.in_district);
    form.find('#' + field + '_notes').val(address.notes);
  }
  
  function open_form_for_creating(field) {
    $("." + field + "_address_details").hide();
    form = $("#" + field + "-address-form");
    form.parent().find('button:first span').text('Add Address');
    form.dialog( "open" );    
  }
  
  function open_form_for_editing(field) {
    $("." + field + "_address_details").hide();
    form = $("#" + field + "-address-form");
    form.parent().find('button:first span').text('Save Address');
    form.dialog( "open" );    
  }
  
  function edit_pickup_address() {
    open_form_for_editing('pickup');
  }

  function edit_dropoff_address() {
    open_form_for_editing('dropoff');
  }
  
  function update_address_fields(field, address){
    id_field = '#trip_' + field + '_address_id';
    $(id_field).val(address.id);
    search_field = '#' + field + '_search_address';
    $(search_field).val(address.label);
    $(search_field).attr("data-original-value", address.label);
    $(search_field).attr("data-original-id", address.id);
  }

  $(document).ready(function() {
    makeDatetimePickers();

    function load_edit_trip(form) {
      makeDialogs();
      makeDatetimePickers();
    }
    
    // happens after you submit an address (not autocomplete)
    // an id should be returned, and then the form should close.
    // if no id is returned, error messages are filled in. 
    $("body").on('ajax:success', '.address-search', function(evt, data, status, xhr){
      if (data.id) {
        update_address_fields(data.prefix, data);      

        if (data.prefix == 'dropoff') {
          if (data.phone_number) $("#dropoff_phone").val(data.phone_number);
          if (data.trip_purpose) $("#trip_trip_purpose").val(data.trip_purpose);
        }
        
        $( $(this)[0].parentNode ).dialog( "close" );
        populate_address_form(data.prefix, data);
        $("." + data.prefix + "_address_details").show();
      } else {
        //failed to create an address
        for (var field in data) {
          text_field = $('#' + data.prefix + "_" + field);
          error_element = text_field.attr('data-error-element');
          if (!error_element) {
            error_element_id = data.prefix + "_" + field
            text_field.after('<span class="error" id="' + error_element_id + '">' + data[field] + "</span>");
            error_element = "#" + error_element_id;
            text_field.attr('data-error-element', error_element);
          }
          $(error_element).innerHtml = data[field]
        }
      }
    })
    
    // address dialog functionality
    // via http://jqueryui.com/demos/dialog/#modal-form 
    function makeDialogs() {
      $( ".address-form" ).dialog({
          autoOpen: false,
          height: 395,
          width: 600,
          modal: true,
          buttons: {
              "Add Address": function() {
                  form = $( this )[0].children[0];
                  $(form).trigger('submit'); 
              },
              Cancel: function() {
                $( this ).dialog( "close" );
              }
          },
          close: function() {
              var prefix = $(this).attr("id").replace(/\-address\-form/, "");
              var field  = $( "#" + prefix + "_search_address" );
              field.val( field.attr("data-original-value") );
              $("#trip_" + prefix + "_address_id").val(field.attr("data-original-id"));
              if (parseInt(field.attr("data-original-id")) > 0)
                  $("." + prefix + "_address_details").show();
          }
      });
    };
    
    makeDialogs();

    $("body").on('railsAutocomplete.select', '#pickup_search_address', function(e, selected){
      autocompleted(selected.item, 'pickup');
    });
    
    $("body").on('railsAutocomplete.select', '#dropoff_search_address', function(e, selected){
      autocompleted(selected.item, 'dropoff');
    });
    
    $("body").on('change', '#trip_pickup_time', function() {
      var date = ISODateFormatToDateObject( $(this).val() );
      var date_formatted = date.getFullYear() + "-" + (date.getMonth()+1) + "-" + date.getDate();
      $.getJSON("<%= for_date_runs_path %>", { date : date_formatted }, function(data){
        selected = $("#trip_run_id").val();
        $("#trip_run_id option").remove();
        $("#trip_run_id").append( $("<option>") );
        $.each( data, function(i, run){
          var option = $("<option>").val(run.id).text(run.label);
          $("#trip_run_id").append( option );
        })
        $("#trip_run_id").val(selected);
      })
    });
  });
</script>